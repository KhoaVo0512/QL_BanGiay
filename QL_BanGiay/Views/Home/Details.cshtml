@using System.Globalization;
@model QL_BanGiay.Data.Giay
@{
    ViewData["Title"] = Model.TenGiay;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var data = 0;
    CultureInfo elGR = CultureInfo.CreateSpecificCulture("el-GR");
}
<link rel="stylesheet" href="~/css/details.css" />
<section class="product-wrapper pt-50 pb-50">
    <div class="block">
        <div class="container">
            <ul class="breadcrumbs">
                <li><a href="/">Trang chủ</a></li>
                <li>/<span>@Model.TenGiay</span></li>
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="card-wrapper">
            <div class="card">
                <!-- card left -->
                <div class="product-imgs">
                    <div class="img-display">
                        <div class="img-showcase">
                            <img src="@Model.AnhDd" alt="shoe image">
                            @foreach (var item in Model.AnhGiays)
                            {
                                <img src="@item.Url" alt="shoe image">
                            }
                        </div>
                    </div>
                    <div class="img-select">
                        @foreach (var item in Model.AnhGiays)
                        {
                            data = data + 1;
                            <div class="img-item">
                                <a href="#" data-id="@data">
                                    <img src="@item.Url" alt="shoe image">
                                </a>
                            </div>

                        }
                    </div>
                </div>
                <!-- card right -->
                <div class="product-content">
                    <h2 class="product-title">@Model.TenGiay-@Model.MaGiay</h2>
                    <div class="product-price">
                        <p class="new-price">Giá: <span>@String.Format(elGR, "{0:0,0}", Model.GiaBan) VND</span></p>
                    </div>

                    <div class="product-detail">
                        <h2>Tóm tắt về sản phẩm: </h2>
                        <p>@Model.TomTat</p>
                    </div>
                    <div class="col-md-7">
                        <div class="single-form form-default form-border">
                            <div class="form-input">
                                <select id="size" class="form-select" aria-label="Default select example" asp-items="ViewBag.SizeList">
                                </select>
                                <div id="selectError"></div>
                            </div>
                        </div>
                    </div>
                    <div class="purchase-info">
                        <div class="quantity d-block mb-25 mt-sm-2" data-name="@Model.TenGiay" data-id="@Model.MaGiay" data-price="@Model.GiaBan" data-image="@Model.AnhDd">
                            <label class="font-weight-600 no-margin-bottom">Số lượng:</label>
                            <span class="padding-5px border-light-gray sm-text-large mr-70">
                                <a href="javascript:void(0)" class="minus-btn text-black"><i class="fas fa-minus bg-transparent"></i></a>
                                <input onchange="change();" id="quanlity" type="text" name="name" value="1" class="count border-left-light-gray border-right-light-gray">
                                <a href="javascript:void(0)" class="plus-btn text-black"><i class="fas fa-plus bg-transparent"></i></a>
                            </span>
                            <button href="javascript:void(0);" class="btn btn-danger mt-10">
                                Thêm vào giỏ hàng
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            <div id="inputError"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        @Html.Raw(Model.NoiDung)
    </div>  
</section>
@section Scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const imgs = document.querySelectorAll('.img-select a');
        const number = /[a-z,A-Z]/;
        const special = /[ `!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
        var select = document.getElementById('size');
        var selectValue = select.options[select.selectedIndex].value;
        function change() {
            var input = document.getElementById('quanlity');
            if (number.test(input.value)) {
                input.value = 1;
                input.innerHTML = 1;

            }
            else if (special.test(input.value)) {
                input.value = 1;
                input.innerHTML = 1;              
            } 
        }
        const imgBtns = [...imgs];
        let imgId = 1;

        imgBtns.forEach((imgItem) => {
            imgItem.addEventListener('click', (event) => {
                event.preventDefault();
                imgId = imgItem.dataset.id;
                slideImage();
            });
        });

        function slideImage() {
            const displayWidth = document.querySelector('.img-showcase img:first-child').clientWidth;

            document.querySelector('.img-showcase').style.transform = `translateX(${- (imgId - 1) * displayWidth}px)`;
        }

        window.addEventListener('resize', slideImage);
        var products = document.querySelector('.quantity button');
        products.addEventListener('click', function (e) {
            var select = document.getElementById('size');
            var selectValue = select.options[select.selectedIndex].value;
            var input = document.getElementById('quanlity');
            if (selectValue == '') {
                helpers.setHtml('selectError', '<p class="text-danger">Vui lòng chọn size sản phẩm</p>');
            }
            else {
                var select = document.getElementById('size');
                var selectValue = select.options[select.selectedIndex].value;
                var getdiv = document.querySelector('.quantity');
                var input = document.getElementById('quanlity');
                console.log(getdiv);
                console.log(this.parentNode);
                $.ajax ({
                    url: "/Home/checkproduct?id=" + '@Model.MaGiay' + "&idSize=" + selectValue,
                    type: "GET",
                    success: function (data){
                        const parsed = parseInt(input.value);
                        if (data < parsed) {
                            if (selectValue != '') {
                                helpers.setHtml('selectError', '');
                            }
                            helpers.setHtml('inputError', '<p class="text-danger">Vui lòng chọn số lượng dưới ' + (data + 1) + ' đôi.</p>');
                        }else {
                            var items = storage.getCart();
                            var item = helpers.itemData(getdiv);
                            let blt = true;
                            if (items != null){
                                for (var i =0 ;i< items.length;i++){
                                    if ((items[i].id == item.id) && (items[i].idsize == item.idsize)){
                                        var quantity = parseInt(items[i].count)  + parseInt(item.count);
                                        if (quantity > data){
                                            helpers.setHtml('inputError', '<p class="text-danger">Số lượng trong kho đã giới hạn vui lòng không mua thêm.</p>');
                                            blt = false;
                                        }
                                        else{
                                                helpers.setHtml('selectError', '');
                                                helpers.setHtml('inputError', '');
                                                cart.addItem(item);
                                                if (storage.getCart()) {
                                                    var checkout = document.getElementById('checkout-footer');
                                                    checkout.innerHTML = "<div class='checkout-btn'><a href = '/cart' style = 'margin-top: 10px;margin-bottom: 10px;' class='main-btn primary-btn-border'>Xem giỏ hàng</a><a href='/checkout' style='float: right !important;margin-bottom: 10px;margin-top: 10px;' class='main-btn primary-btn'>Đặt hàng</a></div>";
                                                }
                                                document.getElementById("cartCount").textContent = storage.getCart().length;
                                                toastr.success("Thêm giỏ hàng thành công");
                                                blt = false;
                                                break;
                                        }

                                    }
                                }
                                if (blt) {
                                    helpers.setHtml('selectError', '');
                                    helpers.setHtml('inputError', '');
                                    cart.addItem(item);
                                    if (storage.getCart()) {
                                        var checkout = document.getElementById('checkout-footer');
                                        checkout.innerHTML = "<div class='checkout-btn'><a href = '/cart' style = 'margin-top: 10px;margin-bottom: 10px;' class='main-btn primary-btn-border'>Xem giỏ hàng</a><a href='/checkout' style='float: right !important;margin-bottom: 10px;margin-top: 10px;' class='main-btn primary-btn'>Đặt hàng</a></div>";
                                    }
                                    document.getElementById("cartCount").textContent = storage.getCart().length;
                                    toastr.success("Thêm giỏ hàng thành công");
                                }
                            }else {
                                helpers.setHtml('selectError', '');
                                helpers.setHtml('inputError', '');
                                cart.addItem(item);
                                if (storage.getCart()) {
                                    var checkout = document.getElementById('checkout-footer');
                                    checkout.innerHTML = "<div class='checkout-btn'><a href = '/cart' style = 'margin-top: 10px;margin-bottom: 10px;' class='main-btn primary-btn-border'>Xem giỏ hàng</a><a href='/checkout' style='float: right !important;margin-bottom: 10px;margin-top: 10px;' class='main-btn primary-btn'>Đặt hàng</a></div>";
                                }
                                document.getElementById("cartCount").textContent = storage.getCart().length;
                                toastr.success("Thêm giỏ hàng thành công");
                            }
                        }
                    }
                });      
            }
        });

    </script>
}